---
title: "Modelación filogeográfica (observacional)"

author: ["Miguel Equihua"]
date: "2026-02-04"
lang: es
draft: false
categories: [ejemplo]

format:
  html:
    code-fold: true
---

```{r}
#| label: setup
#| echo: false
#| warning: false
#| message: false

library(dplyr)
library(flextable)
library(ggplot2)
library(stringr)
library(officer)

```



## Pregunta de investigación

Queremos analizar si la **distancia genética** entre poblaciones de una especie (medida como divergencia en secuencias de ADN mitocondrial) está asociada con la **distancia geográfica** (en kilómetros) entre esas poblaciones. Pensamos que existe una **relación positiva** que provoca que a mayor distancia geográfica ocurra también una mayor divergencia genética.  La razón para pensar así es la la hipótesis de **aislamiento por distancia**, una proposición común en estudios filogeográficos.  En términos biológicos estamos considerando que las poblaciones que están más alejadas físicamente sostienen un menor flujo génico y, por tanto, con el paso del tiempo habrán acumulado mayor cantidad de diferencias genéticas.

Tradicionalmente, al gremio filogeográfico, le gusta analizar este tipo de cuestiones  con la llamada prueba de  **Mantel** (enfoque *no paramétrico* que analiza estadísticamente la correlación entre matrices de distancia genética y geográfica). Además, los resultados de esos análisis se suelen ilustrar con visualizaciones mediante mapas que destacan gradientes que asocian las divergencias. 

La prueba de **Mantel clásica** aplicada a matrices de disimilitud ($D_{1}\ \text{ y } D_{2}$), es linealmente equivalente a una regresión lineal ($y=\beta_{0}+\beta_{1}x$), en donde las observaciones o *datos*, son las parejas que se forman al *empatar los valores correspondientes en las matrices*. Para contrtuir el enfoque de regresión, consideraríamos que la *variable de respuesta* ($y$), son los elementos de la matriz de distancia genética, $D_{1}$.  La *variable explicaiva* ($x$), serán los elementos de la matriz de distancia geográfica $D_{2}$. El modelo, claramente, explora así la posibilidad de *predecir* los valores de la matriz $D_{1}$ dados los de la matriz $D_{2}$.

Para enriquecer el ejemplo, consideremos que además el fenómeno se desarrolla sobre **regiones geográficas**. En tal caso, habría que evaluar si la relación entre distancia genética y distancia geográfica es igual en los distintoss territorios, o si hay diferencias que reflejen historias evolutivas y ecológicas particulares. ¿Habrá variables adicionales que permitan explorar esas historias? ¿habrá procesos de confusión de efectos que habría que considerar?.



### Datos

Supongamos que estudiamos la especie *Mi alegría* está distribuida en **dos regiones**:  
- **Región A (bosques húmedos)**  
- **Región B (zonas áridas)**  

Queremos ver si el patrón de aislamiento por distancia (relación entre distancia genética y distancia geográfica) es un fenómeno que está experimentando la especie en cada región.


### Modelo 
Podemos usar una regresión simple extendida con un **factor cualitativo de región**:

$$
\begin{align*}
\text{Distancia genética} &= \beta_0 + \beta_1 \cdot \text{Distancia geográfica} + \beta_2 \cdot \text{Región} + \beta_3 \cdot (\text{Distancia geográfica} \times \text{Región}) + \varepsilon \\ 
\\
\text{o, en forma más compacta}\\  
\\
D_{gen} &= \mu + D_{geo} + R + RD_{geo} + \varepsilon
\end{align*}
$$
En donde:

- $D{geo}$: grado de relación entre distancias (genética y geográfica)  
- $R$: efecto de la región sobre la relación entre distancias.  
- $RD{geo}$: compotamiento diferencial de la distancia geográfica entre regiones.  

### Procesos biológicos hipotéticos
- En **bosques húmedos**, las poblaciones están más aisladas y la distancia geográfica se traduce en mayor divergencia genética (probablemente por barreras físicas como montañas o ríos).  
- En **zonas áridas**, el flujo génico puede ser más amplio (quizá por dispersión aérea o menor fragmentación), reduciendo el efecto del aislamiento por distancia.  
- El contraste muestra que **los procesos filogeográficos no son homogéneos**: dependen del paisaje y la ecología regional.


### Valores hipotéticos (para simular)
- **Región A (bosques húmedos):**  
  $D_{geo} = 0.01$ con un efecto adicional de $R = 0.0003$, 
  imaginamos que está ocurriendo un fuerte aislamiento por distancia: cada 100 km aumenta en 0.03 unidades la divergencia genética.  

- **Región B (zonas áridas):**  
  $D_{geo} = 0.02$ con un efecto adicional de $R = 0.0001$,  
  imaginamos que el aislamiento por distancia es más débil aca: cada 100 km aumenta sólo en 0.01 unidades la divergencia genética.  


### Simulación de datos

Las matrices de distancia se ven así

```{r}
#| echo: true
#| warning: false
#| message: false

datos <- data.frame(
  distancia_geo = c(50,120,300,80,250,200, 60,150,280,90,260,210),
  distancia_gen = c(0.01,0.03,0.06,0.02,0.05,0.04, 0.02,0.025,0.04,0.022,0.03,0.028),
  region = factor(rep(c("_bosque_humedo","_zona_arida"), each = 6))
)


mat_reg_bosque<- matrix(0, nrow = 4, ncol = 4)
mat_reg_bosque[lower.tri(mat_reg_bosque)] <- datos$distancia_geo[1:6]
mat_reg_bosque <- mat_reg_bosque + t(mat_reg_bosque)

mat_reg_matorral <- matrix(0, nrow = 4, ncol = 4)
mat_reg_matorral[lower.tri(mat_reg_matorral)] <- datos$distancia_geo[7:12]
mat_reg_matorral <- mat_reg_matorral + t(mat_reg_matorral)

mat_gen_reg_bosque <- matrix(0, nrow = 4, ncol = 4)
mat_gen_reg_bosque[lower.tri(mat_gen_reg_bosque)] <- datos$distancia_gen[1:6]
mat_gen_reg_bosque <- mat_gen_reg_bosque + t(mat_gen_reg_bosque)

mat_gen_reg_matorral <- matrix(0, nrow = 4, ncol = 4)
mat_gen_reg_matorral[lower.tri(mat_gen_reg_matorral)] <- datos$distancia_gen [7:12]
mat_gen_reg_matorral <- mat_gen_reg_matorral + t(mat_gen_reg_matorral)




# --- Heatmap geográfico --- 
library(tidyr)
melt_geo <-  mat_reg_bosque |> 
  as_tibble(rownames = "row", .name_repair = "unique")  |> 
  pivot_longer(-row, names_to = "col", values_to = "valor") |> 
  mutate(col = rep(1:4, times = 4),
         row = as.integer(row))

ggplot(melt_geo, aes(col, -row, fill = valor)) + 
  geom_tile() + 
  geom_text(aes(label=valor), color="white") + 
  scale_fill_gradient(low="lightblue", high="darkblue", name = "dist") + 
  labs(title="Matriz de distancia geográfica (km)",
       subtitle = "Bosque húmedo", x="Población", y="Población") + 
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.title = element_blank())


melt_geo <-  mat_reg_matorral|> 
  as_tibble(rownames = "row", .name_repair = "unique"  )  |> 
  pivot_longer(-row, names_to = "col", values_to = "valor") |> 
  mutate(col = rep(1:4, times = 4),
         row = as.integer(row))
ggplot(melt_geo, aes(col, -row, fill = valor)) + 
  geom_tile() + 
  geom_text(aes(label=valor), color="white") + 
  scale_fill_gradient(low="lightblue", high="darkblue", name = "dist") + 
  labs(title="Matriz de distancia geográfica (km)",
       subtitle = "Matorral xerófilo", x="Población", y="Población") + 
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.title = element_blank())

# --- Heatmap genético --- 
melt_geo <-  mat_gen_reg_bosque |> 
  as_tibble(rownames = "row", .name_repair = "unique")  |> 
  pivot_longer(-row, names_to = "col", values_to = "valor") |> 
  mutate(col = rep(1:4, times = 4),
         row = as.integer(row))

ggplot(melt_geo, aes(col, -row, fill = valor)) + 
  geom_tile() + 
  geom_text(aes(label=valor), color="white") + 
  scale_fill_gradient(low="lightgreen", high="darkgreen", name = "dist") + 
  labs(title="Matriz de distancia genética (p-dist)",
       subtitle = "Bosque húmedo", x="Población", y="Población") + 
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.title = element_blank())


melt_geo <-  mat_gen_reg_matorral|> 
  as_tibble(rownames = "row", .name_repair = "unique" )  |> 
  pivot_longer(-row, names_to = "col", values_to = "valor") |> 
  mutate(col = rep(1:4, times = 4),
         row = as.integer(row))
ggplot(melt_geo, aes(col, -row, fill = valor)) + 
  geom_tile() + 
  geom_text(aes(label=valor), color="white") + 
  scale_fill_gradient(low="lightgreen", high="darkgreen", name = "dist") + 
  labs(title="Matriz de distancia genética (p-dist)",
       subtitle = "Matorral xerófilo", x="Población", y="Población") + 
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.title = element_blank())

```

```{r}
datos |> 
  mutate(reg_alfa = if_else(str_detect(region, "bosq"),
                            "Bosque húmedo", 
                            "Matorral xerófilo")) |> 
  select(distancia_gen,distancia_geo,reg_alfa) |> 
  flextable() |> 
  add_header_row(values = c("Distancia", ""), colwidths = c(2,1)) |> 
  set_header_labels(distancia_gen = "Genética",
                    distancia_geo = "Geográfica",
                    reg_alfa = "Región") |> 
  align(i = 1:2, part = "header", align = "center") |> 
  align(j = 3, align = "center") |> 
  border(i = 1, j = 3, part = "header", border.bottom = fp_border(color = "white", width = 2)) |> 
  width(j = 3, width = 2)

```


```{r}

# Modelo con interacción
modelo <- lm(distancia_gen ~ distancia_geo * region, data = datos)
summary(modelo)

```


```{r}

# Visualización
ggplot(datos, aes(x=distancia_geo, y=distancia_gen, color=region)) +
  geom_point(size=3) +
  geom_smooth(method="lm", se=FALSE) +
  labs(x="Distancia geográfica (km)", 
       y="Distancia genética (p-dist)",
       title="Contraste de aislamiento por distancia entre regiones") +
  theme_minimal()

```


En filogeografía, tanto el **test de Mantel** como la **regresión** se usan para evaluar la relación entre matrices de distancia genética y geográfica, pero tienen diferencias importantes:

El Test de Mantel calcula la correlación entre dos matrices de distancia (ej. genética vs geográfica).  

- **Ventajas:**
  - Es el método clásico para probar la hipótesis de **aislamiento por distancia**.  
  - Funciona directamente con matrices simétricas de distancias.  
  - Usa permutaciones para evaluar significancia, lo que lo hace robusto frente a distribuciones no normales.  
- **Limitaciones:**
  - No estima coeficientes de regresión ni intercepto (solo da una correlación).  
  - Puede ser sensible a la autocorrelación espacial y a estructuras jerárquicas.  
  - Menos flexible si quieres incluir variables adicionales o interacciones.

Por su lado, la regresión (ej. regresión lineal o modelos mixtos) se orienta a construir un modelo que prediga la distancia genética como una función de la distancia geográfica (y otras covariables si quieres).  

- **Ventajas:**
  - Permite estimar **coeficientes de refresión (efectos), intercepto y significancia estadística**.  
  - Se puede extender a modelos más complejos (ej. incluir región, ambiente, barreras).  
  - Más interpretativo: puedes decir “cada 100 km aumenta en X unidades la divergencia genética”. 
- **Limitaciones:**
  - Requiere transformar matrices en vectores de pares (lo que rompe la independencia estadística).
  - Si no se ajusta con métodos adecuados (ej. modelos mixtos o GLS), puede inflar la significancia.  
  - Menos robusto que Mantel si solo quieres probar correlación simple.



Auque generalmente se considera a Matel como más directo y simple, en el ejemplo vemos  que, si interesa un **contraste entre regiones**, la **regresión con interacción** es más poderosa porque te permite comparar pendientes e interceptos. El Mantel te daría solo una correlación por región, sin mostrar cómo cambia la intensidad del aislamiento por distancia.  


```{r}
#| echo: false
#| eval: false
#| include: false

# --- Función para simular datos filogeográficos con contraste regional ---
simular_datos <- function(
  n_por_region = 6,
  beta0_A = 0.01, beta1_A = 0.0003, sd_A = 0.005,
  beta0_B = 0.02, beta1_B = 0.0001, sd_B = 0.005,
  rango_dist = c(50, 300)
){
  # Distancias geográficas simuladas
  dist_geo_A <- seq(rango_dist[1], rango_dist[2], length.out = n_por_region)
  dist_geo_B <- seq(rango_dist[1], rango_dist[2], length.out = n_por_region)
  
  # Distancias genéticas simuladas con ruido normal
  dist_gen_A <- beta0_A + beta1_A * dist_geo_A + rnorm(n_por_region, 0, sd_A)
  dist_gen_B <- beta0_B + beta1_B * dist_geo_B + rnorm(n_por_region, 0, sd_B)
  
  # Construcción del data frame
  datos <- data.frame(
    distancia_geo = c(dist_geo_A, dist_geo_B),
    distancia_gen = c(dist_gen_A, dist_gen_B),
    region = factor(rep(c("_Bosque_humedo","_Zona_arida"), each = n_por_region))
  )
  
  return(datos)
}

# --- Ejemplo de uso ---
set.seed(123)
datos_sim <- simular_datos(
  n_por_region = 6,
  beta0_A = 0.01, beta1_A = 0.0003, sd_A = 0.002,
  beta0_B = 0.02, beta1_B = 0.0001, sd_B = 0.002
)

print(datos_sim)

```

