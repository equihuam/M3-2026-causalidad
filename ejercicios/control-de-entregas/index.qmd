---
title: "Registro de entregas"
author: "Miguel Equihua"
format: html

lang: es

image: img/bad-mark-624734_1280.jpg
---

```{r}
#| label: setup
#| echo: false
#| warning: false
#| message: false

# Outlook 365
pacman::p_load(Microsoft365R, dplyr, stringr, DT, flextable, glue)

# Recupera los mensajes de interés
alumnos <- read.csv("../../posts/00-Bienvenida/Lista-de-alumnos-2026.csv")
outlb <- get_business_outlook()
inbox_ref <- outlb$get_inbox()
m3_2026 <- inbox_ref$get_folder("m3-2026")
correos <- m3_2026$list_emails(n = 1000)  # filter = paste0("receivedDateTime ge ", "2026-01-25")

# Prepara la tabla de registro de correos y su tipo dw contenido
tabla_correo <- tibble(fecha = character(), 
                       alumno = character(), 
                       archivo = character())


for (correo in correos)
{
  remitente <-  correo$properties$sender$emailAddress$address
  asunto <- correo$properties$subject
  fecha  <- as.POSIXlt( as.Date(correo$properties$receivedDateTime))
  year <- fecha$year + 1900
  mes <- fecha$mon + 1
  if (remitente == "lucia.8413.17@gmail.com") 
    remitente <- "lucia.rodriguez@posgrado.ecologia.edu.mx"
  
  if (remitente == "alvaradomezaeric@yahoo.com")
    remitente <- "eric.alvarado@posgrado.ecologia.edu.mx  "
    
  alumno <- alumnos$alumno[str_detect(remitente, alumnos$correo)]
  fecha_str <- str_extract(correo$properties$receivedDateTime, ".*(?=T)")

  if (str_detect(str_to_lower(asunto), "m3-2026|m3 2026|m3_2026|mm-2026"))
  {
    d  <- correo$list_attachments()

    if (length(d) == 0)
    { 

     #  Bloque sin adjuntos o con un link de descarga
      anexo <- paste0(asunto, " - sin anexo")
      if (str_detect(correo$properties$body$content, "subí al Drive "))  
          anexo <- str_extract(correo$properties$body$content, '(?<=href=")(.*)(?=">https)')
      
      tabla_correo <- bind_rows(tabla_correo, c(fecha = fecha_str,
                                                alumno = alumno,
                                                archivo = anexo)) |> 
        mutate(tipo = if_else(str_detect(str_to_lower(archivo),
                                    "ejerc|tarea|descrip|dag|larva|curso|http|aedes|ejercicio3_"),
                                    "ejercicio", "lectura"),   
               id_num = str_extract(archivo, "(?<=\\-|_|\\s)(\\d+)(?=\\-|_|\\s)"),
               id_num = str_remove(id_num, "0"),
               id_num = if_else(str_detect(str_to_lower(archivo),"dag"), "2", id_num),
               id_num = if_else(str_detect(str_to_lower(archivo),   
                                "larva|curso|http|aedes|mosquitos"), "3", id_num),
               id_num = if_else(str_detect(str_to_lower(archivo), 
                                "ejercicio3_|presentación  "), "4", id_num)) 
    } else {

      if (length(d) == 1)
      {
        # Bloque con un solo anexo 
        d[[1]]$properties$sourceUrl
        anexo <- d[[1]]$properties$name
        if (str_detect(str_to_lower(anexo), "lect"))     
        {
          d[[1]]$download(dest = paste0("_lecturas/",anexo), 
                        overwrite = TRUE)
        } else {
          d[[1]]$download(dest = paste0("_tareas/",anexo), 
                          overwrite = TRUE)
        } 

        tabla_correo <- bind_rows(tabla_correo, c(fecha = fecha_str,
                                                  alumno = alumno,
                                                  archivo = anexo)) |> 
              mutate(tipo = if_else(str_detect(str_to_lower(archivo),
                                    "ejerc|tarea|descrip|dag|larva|curso|http|aedes|ejercicio3_"),
                                    "ejercicio", "lectura"), 
                     id_num = str_extract(archivo, "(?<=\\-|_|\\s)(\\d+)(?=\\-|_|\\s)"),
                     id_num = str_remove(id_num, "0"),
                     id_num = if_else(str_detect(str_to_lower(archivo),"dag"), "2", id_num),
                     id_num = if_else(str_detect(str_to_lower(archivo),   
                                      "larva|curso|http|aedes|mosquitos"), "3", id_num),
                     id_num = if_else(str_detect(str_to_lower(archivo), 
                                      "ejercicio3_|presentación"), "4", id_num)) 
      } else {
        
          # Bloque con 2 o más anexos
          for (i in (1:length(d)))
          { 
            d[[1]]$properties$sourceUrl
            anexo <- d[[1]]$properties$name
            
            if (str_detect(str_to_lower(anexo), "lect"))
            {
              d[[i]]$download(dest = paste0("_lecturas/", anexo), 
                            overwrite = TRUE)
            } else {
              d[[i]]$download(dest = paste0("_tareas/", anexo), 
                              overwrite = TRUE)
            } 
            
            tabla_correo <- bind_rows(tabla_correo, 
                                      c(fecha = fecha_str,
                                        alumno = alumno,
                                        archivo = anexo)) |>
              mutate(tipo = if_else(str_detect(str_to_lower(archivo),
                                    "ejerc|tarea|descrip|dag|larva|curso|http|aedes|ejercicio3_"),
                                    "ejercicio", "lectura"), 
                     id_num = str_extract(archivo, "(?<=\\-|_|\\s)(\\d+)(?=\\-|_|\\s)"),
                     id_num = str_remove(id_num, "0"),
                     id_num = if_else(str_detect(str_to_lower(archivo),"dag"), "2", id_num),
                     id_num = if_else(str_detect(str_to_lower(archivo),   
                                      "larva|curso|http|aedes|mosquitos"), "3", id_num),
                     id_num = if_else(str_detect(str_to_lower(archivo), 
                                      "ejercicio3_"), "4", id_num)) 
        }
      }
    }
  }
}

# datos adicionales
tabla_correo <- tabla_correo |>
  distinct(archivo, .keep_all = TRUE) |>
  filter(!str_detect(archivo, "sin anexo")) |> 
  arrange(tipo, id_num)
```

\

El conteo de tareas recibidas hasta el día `r format(Sys.time(), "%e de %B, %Y")` es el que sigue.

\
\

```{r}
#| label: cuadro-resumen
#| echo: false
#| warning: false
#| message: false
#| tbl-cap: "Número de entregas registradas"


tabla_correo |> 
  group_by(tipo, id_num) |> 
  summarise(cantidad = n(), .groups = "drop") |> 
  flextable() |> 
  bold(bold = TRUE, part = "header") |> 
  width(j = 1:3, width = c(2,1,1)) |> 
  set_header_labels(tipo = "Tipo", id_num = "id", cantidad = "Cantidad") |> 
  color(i = ~ str_detect(tipo, "ejercicio"), color = "blue")
```
\
\

Los documentos que he recibido son los que están en esta lista.

\
\


```{r}
#| label: entregas
#| echo: false

tabla_correo |> 
  arrange(archivo) |> 
  datatable(colnames = c("Recibido", "Alumno", "Archivo"), 
            filter = "top", 
            options = list(pageLength = 15))

```





